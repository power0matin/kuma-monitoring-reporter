logging.basicConfig(
    filename='logs/error.log',
    level=logging.INFO,  # تغییر از ERROR به INFO برای ثبت جزئیات بیشتر
    format='%(asctime)s %(levelname)s %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

def main():
    config = load_config()
    logging.info("Starting main job...")
    try:
        raw_metrics = fetch_metrics(config["kuma_url"], config["auth_token"])
        logging.info(f"Fetched raw metrics: {raw_metrics[:100]}...")  # بخشی از متریک‌ها
        metrics = parse_prometheus_metrics(raw_metrics)
        logging.info(f"Parsed metrics: {metrics}")
        message = format_message(metrics, config["thresholds"])
        logging.info(f"Formatted message: {message}")
        send_telegram_message(
            config["telegram_bot_token"], config["telegram_chat_id"], message
        )
        logging.info("Message sent successfully")
    except Exception as e:
        logging.error(f"Error in main: {e}")
        print(f"[!] Error: {e}")