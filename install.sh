#!/bin/bash

# üåü kuma-monitoring-reporter Installer üöÄ

REPO_URL="https://github.com/power0matin/kuma-monitoring-reporter.git"
PROJECT_DIR="$HOME/kuma-monitoring-reporter"
VENV_DIR="$PROJECT_DIR/venv"
CONFIG_FILE="$PROJECT_DIR/config/config.json"
SERVICE_NAME="kuma-reporter"
SERVICE_FILE="/etc/systemd/system/$SERVICE_NAME.service"
LOG_FILE="$PROJECT_DIR/logs/install.log"

# üé® Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# üõ†Ô∏è Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# üåê Function to check GitHub connectivity
check_github_connectivity() {
    echo -e "${CYAN}üåê Checking connectivity to GitHub...${NC}" | tee -a "$LOG_FILE"
    if ! ping -c 1 github.com >/dev/null 2>&1; then
        echo -e "${RED}‚ùå Cannot connect to GitHub. Check your network connection.${NC}" | tee -a "$LOG_FILE"
        read -p "Press Enter to continue..."
        return 1
    fi
    return 0
}

# üìÅ Function to setup directories and log files
setup_dirs() {
    mkdir -p "$PROJECT_DIR/logs" "$PROJECT_DIR/config" "$PROJECT_DIR/core" "$PROJECT_DIR/notifier"
    touch "$PROJECT_DIR/logs/install.log" "$PROJECT_DIR/logs/error.log"
}

# üì¶ Function to install system dependencies
install_system_deps() {
    setup_dirs
    echo -e "${YELLOW}üì¶ Installing system dependencies...${NC}" | tee -a "$LOG_FILE"
    sudo apt-get update >> "$LOG_FILE" 2>&1
    sudo apt-get install -y git python3 python3-pip python3-venv jq >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to install dependencies. Check $LOG_FILE for details.${NC}" | tee -a "$LOG_FILE"
        read -p "Press Enter to continue..."
        return 1
    }
    echo -e "${GREEN}üéâ System dependencies installed!${NC}" | tee -a "$LOG_FILE"
    return 0
}

# üöÄ Function to install project
install_project() {
    setup_dirs
    echo -e "${YELLOW}üöÄ Installing kuma-monitoring-reporter...${NC}" | tee -a "$LOG_FILE"
    
    # Check GitHub connectivity
    check_github_connectivity || return 1
    
    # Remove existing directory if it's not a valid git repo
    if [ -d "$PROJECT_DIR" ] && [ ! -d "$PROJECT_DIR/.git" ]; then
        echo -e "${YELLOW}üóë Removing invalid project directory...${NC}" | tee -a "$LOG_FILE"
        rm -rf "$PROJECT_DIR"
    fi
    
    if [ ! -d "$PROJECT_DIR" ]; then
        echo -e "${CYAN}üì• Cloning repository...${NC}" | tee -a "$LOG_FILE"
        git clone "$REPO_URL" "$PROJECT_DIR" >> "$LOG_FILE" 2>&1 || {
            echo -e "${RED}‚ùå Failed to clone repository. Check $LOG_FILE for details.${NC}" | tee -a "$LOG_FILE"
            read -p "Press Enter to continue..."
            return 1
        }
    fi
    
    cd "$PROJECT_DIR" || {
        echo -e "${RED}‚ùå Failed to access project directory${NC}" | tee -a "$LOG_FILE"
        read -p "Press Enter to continue..."
        return 1
    }
    
    # Check if report.py exists
    if [ ! -f "$PROJECT_DIR/report.py" ]; then
        echo -e "${RED}‚ùå report.py not found after cloning. Repository may be incomplete or incorrect.${NC}" | tee -a "$LOG_FILE"
        read -p "Press Enter to continue..."
        return 1
    fi
    
    echo -e "${CYAN}üõ† Creating virtual environment...${NC}" | tee -a "$LOG_FILE"
    python3 -m venv venv
    source venv/bin/activate
    echo -e "${CYAN}üì¶ Installing Python dependencies...${NC}" | tee -a "$LOG_FILE"
    pip install --upgrade pip >> "$LOG_FILE" 2>&1
    # Create requirements.txt if it doesn't exist
    if [ ! -f requirements.txt ]; then
        echo -e "${CYAN}üìù Creating requirements.txt...${NC}" | tee -a "$LOG_FILE"
        cat > requirements.txt <<EOF
requests
schedule
EOF
    fi
    pip install -r requirements.txt >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to install Python dependencies. Check $LOG_FILE for details.${NC}" | tee -a "$LOG_FILE"
        read -p "Press Enter to continue..."
        return 1
    }
    echo -e "${GREEN}üéâ Project installed successfully!${NC}" | tee -a "$LOG_FILE"
    echo -e "Run it with: ${CYAN}source $VENV_DIR/bin/activate; python3 report.py${NC}" | tee -a "$LOG_FILE"
    read -p "Press Enter to continue..."
    return 0
}

# ‚öôÔ∏è Function to configure config.json
configure_json() {
    setup_dirs
    echo -e "${YELLOW}‚öôÔ∏è Configuring config.json...${NC}" | tee -a "$LOG_FILE"
    echo -e "${CYAN}üìù Let's set up your configuration:${NC}"
    read -p "üåê Uptime Kuma metrics URL (e.g., http://localhost:3001/metrics): " kuma_url
    read -p "ü§ñ Telegram bot token: " telegram_bot_token
    read -p "üí¨ Telegram chat ID: " telegram_chat_id
    read -p "üîë Uptime Kuma API key or password (press Enter if not needed): " auth_token
    read -p "‚úÖ Good threshold (ms, e.g., 100): " good
    read -p "‚ö†Ô∏è Warning threshold (ms, e.g., 250): " warning
    read -p "üö® Critical threshold (ms, e.g., 500): " critical
    read -p "‚è∞ Report interval (minutes, e.g., 1): " report_interval

    cat > "$CONFIG_FILE" <<EOF
{
    "kuma_url": "$kuma_url",
    "telegram_bot_token": "$telegram_bot_token",
    "telegram_chat_id": "$telegram_chat_id",
    "auth_token": "$auth_token",
    "thresholds": {
        "good": $good,
        "warning": $warning,
        "critical": $critical
    },
    "report_interval": $report_interval
}
EOF
    echo -e "${GREEN}üéâ Config file created at $CONFIG_FILE${NC}" | tee -a "$LOG_FILE"
    read -p "Press Enter to continue..."
}

# üîÑ Function to update project
update_project() {
    setup_dirs
    clear
    echo -e "${YELLOW}üîÑ Updating kuma-monitoring-reporter...${NC}" | tee -a "$LOG_FILE"

    check_github_connectivity || return 1

    if [ ! -d "$PROJECT_DIR/.git" ]; then
        echo -e "${RED}‚ùå Project directory is not a valid git repository${NC}" | tee -a "$LOG_FILE"
        echo -e "${CYAN}üì• Attempting to re-clone repository...${NC}" | tee -a "$LOG_FILE"
        rm -rf "$PROJECT_DIR"
        git clone "$REPO_URL" "$PROJECT_DIR" >> "$LOG_FILE" 2>&1 || {
            echo -e "${RED}‚ùå Failed to clone repository. Check $LOG_FILE for details.${NC}" | tee -a "$LOG_FILE"
            return 1
        }
    fi

    cd "$PROJECT_DIR" || {
        echo -e "${RED}‚ùå Failed to access project directory${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    echo -e "${CYAN}üì• Pulling latest changes...${NC}" | tee -a "$LOG_FILE"
    git pull origin main >> "$LOG_FILE" 2>&1 || git pull origin master >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to pull latest changes.${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    if [ ! -f "$PROJECT_DIR/report.py" ]; then
        echo -e "${RED}‚ùå report.py not found after update.${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    if [ ! -f "$VENV_DIR/bin/activate" ]; then
        echo -e "${CYAN}üì¶ Creating virtual environment...${NC}" | tee -a "$LOG_FILE"
        python3 -m venv "$VENV_DIR" || {
            echo -e "${RED}‚ùå Failed to create virtual environment${NC}" | tee -a "$LOG_FILE"
            return 1
        }
    fi

    source "$VENV_DIR/bin/activate" || {
        echo -e "${RED}‚ùå Failed to activate virtual environment${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    echo -e "${CYAN}üì¶ Updating Python dependencies...${NC}" | tee -a "$LOG_FILE"
    pip install --upgrade pip >> "$LOG_FILE" 2>&1
    if [ ! -f requirements.txt ]; then
        echo -e "${CYAN}üìù Creating requirements.txt...${NC}" | tee -a "$LOG_FILE"
        cat > requirements.txt <<EOF
requests
schedule
EOF
    fi
    pip install -r requirements.txt >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to update Python dependencies${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    VERSION=$(git describe --tags 2>/dev/null || echo "Unknown")
    echo -e "${GREEN}üéâ Project updated to version: $VERSION${NC}" | tee -a "$LOG_FILE"
    echo -e "Run it with: ${CYAN}source $VENV_DIR/bin/activate; python3 report.py${NC}" | tee -a "$LOG_FILE"
}

# üõ† Function to setup systemd service
setup_service() {
    setup_dirs
    clear
    echo -e "${YELLOW}üõ† Setting up systemd service...${NC}" | tee -a "$LOG_FILE"

    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}‚ùå Config file not found: $CONFIG_FILE${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    if [ ! -f "$PROJECT_DIR/report.py" ]; then
        echo -e "${RED}‚ùå report.py not found in $PROJECT_DIR${NC}" | tee -a "$LOG_FILE"
        return 1
    fi

    echo -e "${CYAN}‚öôÔ∏è Creating systemd service file...${NC}" | tee -a "$LOG_FILE"
    sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=Kuma Monitoring Reporter Service
After=network.target

[Service]
ExecStart=$VENV_DIR/bin/python3 $PROJECT_DIR/report.py
WorkingDirectory=$PROJECT_DIR
Restart=always
User=$USER
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to reload systemd daemon${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    sudo systemctl enable "$SERVICE_NAME" >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to enable $SERVICE_NAME${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    sudo systemctl start "$SERVICE_NAME" >> "$LOG_FILE" 2>&1 || {
        echo -e "${RED}‚ùå Failed to start $SERVICE_NAME${NC}" | tee -a "$LOG_FILE"
        return 1
    }

    echo -e "${GREEN}üéâ Service $SERVICE_NAME started successfully${NC}" | tee -a "$LOG_FILE"
    sudo systemctl status "$SERVICE_NAME" --no-pager
}


# üíæ Function to backup logs
backup_logs() {
    setup_dirs
    echo -e "${YELLOW}üíæ Backing up logs...${NC}" | tee -a "$LOG_FILE"
    backup_dir="$PROJECT_DIR/logs/backup-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$backup_dir"
    cp -r "$PROJECT_DIR/logs/"*.log "$backup_dir" 2>/dev/null || {
        echo -e "${RED}‚ùå No logs found to backup${NC}" | tee -a "$LOG_FILE"
    }
    echo -e "${GREEN}‚úÖ Logs backed up to $backup_dir${NC}" | tee -a "$LOG_FILE"
    read -p "Press Enter to continue..."
}

# üìä Function to show project status
show_status() {
    setup_dirs
    echo -e "${YELLOW}üìä Checking project status...${NC}" | tee -a "$LOG_FILE"
    if [ -d "$PROJECT_DIR" ]; then
        echo -e "${GREEN}‚úÖ Project directory: $PROJECT_DIR${NC}" | tee -a "$LOG_FILE"
        if [ -f "$CONFIG_FILE" ]; then
            echo -e "${GREEN}‚úÖ Config file exists: $CONFIG_FILE${NC}" | tee -a "$LOG_FILE"
        else
            echo -e "${RED}‚ùå Config file missing: $CONFIG_FILE${NC}" | tee -a "$LOG_FILE"
        fi
        if [ -f "$PROJECT_DIR/report.py" ]; then
            echo -e "${GREEN}‚úÖ report.py exists: $PROJECT_DIR/report.py${NC}" | tee -a "$LOG_FILE"
        else
            echo -e "${RED}‚ùå report.py missing: $PROJECT_DIR/report.py${NC}" | tee -a "$LOG_FILE"
        fi
        if sudo systemctl is-active --quiet "$SERVICE_NAME"; then
            echo -e "${GREEN}‚úÖ Service $SERVICE_NAME is running${NC}" | tee -a "$LOG_FILE"
            sudo systemctl status "$SERVICE_NAME" --no-pager
        else
            echo -e "${RED}‚ùå Service $SERVICE_NAME is not running${NC}" | tee -a "$LOG_FILE"
        fi
    else
        echo -e "${RED}‚ùå Project directory not found: $PROJECT_DIR${NC}" | tee -a "$LOG_FILE"
    fi
    read -p "Press Enter to continue..."
}

# üîç Function to check dependencies
check_deps() {
    setup_dirs
    echo -e "${YELLOW}üîç Checking dependencies...${NC}" | tee -a "$LOG_FILE"
    for cmd in git python3 pip jq; do
        if command_exists "$cmd"; then
            echo -e "${GREEN}‚úÖ $cmd is installed${NC}" | tee -a "$LOG_FILE"
        else
            echo -e "${RED}‚ùå $cmd is not installed${NC}" | tee -a "$LOG_FILE"
        fi
    done
    if [ -d "$VENV_DIR" ]; then
        source "$VENV_DIR/bin/activate"
        pip list
    else
        echo -e "${RED}‚ùå Virtual environment not found: $VENV_DIR${NC}" | tee -a "$LOG_FILE"
    fi
    read -p "Press Enter to continue..."
}

# üóëÔ∏è Function to remove project
remove_project() {
    setup_dirs
    echo -e "${YELLOW}üóëÔ∏è Removing kuma-monitoring-reporter...${NC}" | tee -a "$LOG_FILE"
    if [ -d "$PROJECT_DIR" ]; then
        stop_bot
        sudo rm -f "$SERVICE_FILE"
        sudo systemctl daemon-reload >> "$LOG_FILE" 2>&1
        rm -rf "$PROJECT_DIR"
        echo -e "${GREEN}‚úÖ Project removed successfully${NC}" | tee -a "$LOG_FILE"
    else
        echo -e "${RED}‚ùå Project directory not found: $PROJECT_DIR${NC}" | tee -a "$LOG_FILE"
    fi
    read -p "Press Enter to continue..."
}

# üöÄ Service Management Submenu
service_management() {
    while true; do
        clear
        echo -e "\nüåü Service Management Menu"
        echo "-------------------------------------"
        echo "1. Stop bot üõë"
        echo "2. Restart bot üîÑ"
        echo "3. Show service status üìä"
        echo "4. Setup systemd service üõ†Ô∏è"
        echo "0. Back to main menu ‚¨ÖÔ∏è"
        echo "-------------------------------------"
        read -p "Choose an option: " sub_choice
        case $sub_choice in
            1) stop_bot ;;
            2) restart_bot ;;
            3) show_status ;;
            4) setup_service ;;
            0) break ;;
            *) echo -e "${RED}‚ùå Invalid option${NC}" | tee -a "$LOG_FILE"; read -p "Press Enter to continue..." ;;
        esac
    done
}

# üìã Main Menu
while true; do
    clear
    echo -e "\nüåü kuma-monitoring-reporter Installer"
    echo "-------------------------------------"
    echo -e "${CYAN}Welcome to the installer! Choose an action:${NC}"
    echo "1. Install project üöÄ"
    echo "2. Configure config.json ‚öôÔ∏è"
    echo "3. Update project üîÑ"
    echo "4. Service management üõ†Ô∏è"
    echo "5. Test Telegram configuration üì¨"
    echo "6. Backup logs üíæ"
    echo "7. Check dependencies üîç"
    echo "8. Completely remove project üóëÔ∏è"
    echo "0. Exit ‚¨ÖÔ∏è"
    echo "-------------------------------------"
    read -p "Choose an option: " choice

    case $choice in
        1) install_system_deps && install_project ;;
        2) configure_json ;;
        3) update_project ;;
        4) service_management ;;
        5) test_telegram ;;
        6) backup_logs ;;
        7) check_deps ;;
        8) remove_project ;;
        0) clear; echo -e "${YELLOW}‚¨ÖÔ∏è Thanks for using kuma-monitoring-reporter! Exiting...${NC}" | tee -a "$LOG_FILE"; exit 0 ;;
        *) echo -e "${RED}‚ùå Invalid option${NC}" | tee -a "$LOG_FILE"; read -p "Press Enter to continue..." ;;
    esac
done